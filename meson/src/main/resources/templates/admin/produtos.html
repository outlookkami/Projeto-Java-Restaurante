<!DOCTYPE html>
<html lang="pt-BR" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/head :: head('CRUD Produtos')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/modeloTelas.css}">
    <link rel="stylesheet" th:href="@{/css/menu-lateral.css}">
    <link rel="stylesheet" th:href="@{/css/modalIncluir.css}">
    <script th:src="@{/js/modalIncluir.js}"></script>
</head>
<body>

<div class="layout">
    <aside th:replace="~{fragments/menu-lateral-admin :: menu-lateral}"></aside>

    <main class="content">
        <header class="header">
            <h1>Produtos</h1>
            <button type="button" class="btn-primary" onclick="modalAdd()">+ Novo Produto</button>
        </header>

        <div class="div-pesquisa">
            <input id="busca" class="barra-pesquisa" type="text" name="nome" placeholder="Buscar produto..." th:value="${nome}">

            <select id="categoria" class="filtro-categoria">
                <option value="">Todas as categorias</option>
                <option th:each="categoria : ${categorias}" th:text="${categoria.nome}" th:value="${categoria.id}"></option>
            </select>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Imagem</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Categoria</th>
                    <th>Descrição</th>
                    <th>Ativo</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody th:fragment="tabelaProdutos">
                <tr th:each="produto, row : ${produtos}">
                    <td><img th:if="${produto.imagemUrl != null}" th:src="@{${produto.imagemUrl}}" alt=""></td>
                    <td th:text="${produto.nome}"></td>
                    <td th:text="${produto.preco}"></td>
                    <td th:text="${produto.categoria}"></td>
                    <td th:text="${produto.descricao}"></td>
                    <td th:text="${produto.ativo == true} ? 'Sim' : 'Não'"></td>
                    <td>
                        <a th:href="@{/admin/produtos/editar/{id}(id=${produto.id})}"><button class="btn-edit">Editar</button></a>
                        <button type="button" class="btn-delete" th:onclick="'abrirModalExclusao(' + ${produto.id} + ')'">Excluir</button>
                    </td>
                </tr>
            </tbody>
        </table>

    </main>
</div>

<div id="modal" class="modal">
    <div class="modal-conteudo modal-produto">
        <span class="fechar" onclick="fecharModal()">&times;</span>
        <script th:if="${mostrarModal}">
            document.addEventListener("DOMContentLoaded", function (){
                document.getElementById("modal").style.display = "block";
            });
        </script>
        <h3>Novo Produto</h3>

        <form th:action="@{/admin/produtos/salvar}" th:object="${produto}" method="post" enctype="multipart/form-data" id="form" data-action-novo="/admin/produtos/salvar" data-action-editar="/admin/produtos/editar/{id}">
            <div class="form-div">
                <div>
                    <input type="hidden" th:field="*{id}" id="id">
                    <label>Nome do produto:</label>
                    <input type="text" th:field="*{nome}" name="nome" required>
                </div>

                <div>
                    <label>Preço:</label>
                    <input type="number" step="0.01" th:field="*{preco}" name="preco" required>
                </div>

                <div>
                    <label>Categoria:</label>
                    <select th:field="*{idCategoria}" name="idCategoria" required>
                        <option value="">Selecione</option>
                        <option th:each="categoria : ${categorias}" th:text="${categoria.nome}" th:value="${categoria.id}"></option>
                    </select>
                </div>

                <div>
                    <label>Status</label>
                    <select th:field="*{ativo}" name="ativo">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>

                <div>
                    <label>Descrição:</label>
                    <input type="text" th:field="*{descricao}" name="descricao">
                </div>

                <div>
                    <label>Imagem</label>
                    <input type="file" name="imagem" accept="image/*" onchange="previewImagem(event)">
                </div>

                <img id="preview" class="preview-img" style="display:none">

            </div>

            <div class="modal-acoes">
                <button type="submit" class="btn btn-salvar">Salvar</button>
                <button type="button" class="btn btn-cancelar" onclick="fecharModalCategoria()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
    function abrirModalExclusao(id) {
        const form = document.getElementById("formExclusao");
        form.action = "/admin/produtos/excluir/" + id;
        document.getElementById("modalExclusao").style.display = "block";
    }

    function fecharModalExclusao() {
        document.getElementById("modalExclusao").style.display = "none";
    }
</script>

<div class="modalExcluir" id="modalExclusao">
    <div class="modal-conteudo">
        <form method="post" id="formExclusao">
            <p>Tem certeza de que deseja excluir este produto?</p>

            <button type="submit" class="btn-confirmar">Confirmar</button>
            <button type="button" class="btn-cancelar2" onclick="fecharModalExclusao()">Cancelar</button>
        </form>
    </div>
</div>

<script th:src="@{/js/barras-pesquisa/buscarProduto.js}"></script>

<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Dm Sans', 'Inter', Arial, sans-serif;
  }

  .div-pesquisa{
    margin-bottom: 16px;
  }

  .barra-pesquisa{
    width: 400px;
    height: 32px;
    font-size: 14px;
    padding: 5px;
    margin-bottom: 10px;
    border-radius: 20px;
    border: solid 1px #5c3024;
    padding-left: 7px;
    margin-right: 10px;
  }

  .barra-pesquisa:focus{
    border-style: solid 2px #5c3024;
    border-color: #5c3024;
    outline:none;
  }

  .filtro-categoria{
    width:160px;
    border: solid 1px #5c3024;
  }

  .filtro-categoria:focus{
    border-color: #5c3024;
    outline: none;
    border-style: solid 2px #5c3024;
  }

  .form-div{
      display: flex;
      flex-direction: column;
      gap: 10px;
  }

  .modal-produto {
      width: 480px;
      max-width: 95%;
  }

  .modal-produto .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
  }

  .modal-produto textarea {
      grid-column: 1 / -1;
      min-height: 90px;
      resize: vertical;
  }

  .modal-produto input[type="file"] {
      grid-column: 1 / -1;
  }

  .preview-img {
      grid-column: 1 / -1;
      max-height: 180px;
      object-fit: contain;
      border: 1px dashed #ccc;
      border-radius: 6px;
      padding: 8px;
  }

</style>
</body>
</html>
